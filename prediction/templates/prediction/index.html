<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¶è‰‡AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .btn-generate {
            width: 100%;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-generate:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-copy {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid white;
            border-radius: 5px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-copy:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .btn-copy:active {
            background: rgba(255, 255, 255, 0.4);
        }

        .copy-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
            z-index: 9999;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .result-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 600px;
            overflow-y: auto;
            line-height: 1.6;
            word-break: break-word;
            border: 1px solid #ddd;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
            border: 1px solid #f5c6cb;
        }

        .error.active {
            display: block;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
            border: 1px solid #c3e6cb;
        }

        .success.active {
            display: block;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 0.9em;
            border: 1px solid #bee5eb;
        }

        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            display: none;
            border: 1px solid #ffeaa7;
        }

        .warning.active {
            display: block;
        }

        .warning a {
            color: #0056b3;
            text-decoration: underline;
        }

        .warning a:hover {
            color: #004085;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===== ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† ===== -->
        <div class="header">
            <h1>ğŸš¤ ç«¶è‰‡AIäºˆæƒ³ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Django + ChatGPT ã§é«˜ç²¾åº¦ãªç«¶è‰‡äºˆæƒ³ã‚’è‡ªå‹•ç”Ÿæˆ</p>
        </div>

        <!-- ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ===== -->
        <div class="content">
            <!-- ===== å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ éƒ¨åˆ† ===== -->
            <div class="form-section">
                <h2 style="margin-bottom: 20px;">äºˆæƒ³è¨­å®š</h2>
                
                <!-- æƒ…å ±è¡¨ç¤º -->
                <div class="info">
                    ğŸ“Œ ç«¶è‰‡å ´ã€æ—¥ä»˜ã€ãƒ¬ãƒ¼ã‚¹ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                </div>

                <!-- ãƒ•ã‚©ãƒ¼ãƒ è¡Œ -->
                <div class="form-row">
                    <!-- å ´æ‰€é¸æŠ -->
                    <div class="form-group">
                        <label for="location">ğŸ“ ç«¶è‰‡å ´</label>
                        <select id="location">
                            <option value="æ¡ç”Ÿ">æ¡ç”Ÿ</option>
                            <option value="æˆ¸ç”°">æˆ¸ç”°</option>
                            <option value="æ±Ÿæˆ¸å·" selected>æ±Ÿæˆ¸å·</option>
                            <option value="å¹³å’Œå³¶">å¹³å’Œå³¶</option>
                            <option value="å¤šæ‘©å·">å¤šæ‘©å·</option>
                            <option value="æµœåæ¹–">æµœåæ¹–</option>
                            <option value="è’²éƒ¡">è’²éƒ¡</option>
                            <option value="å¸¸æ»‘">å¸¸æ»‘</option>
                            <option value="æ´¥">æ´¥</option>
                            <option value="ä¸‰å›½">ä¸‰å›½</option>
                            <option value="ã³ã‚ã“">ã³ã‚ã“</option>
                            <option value="ä½ä¹‹æ±Ÿ">ä½ä¹‹æ±Ÿ</option>
                            <option value="å°¼å´">å°¼å´</option>
                            <option value="é³´é–€">é³´é–€</option>
                            <option value="ä¸¸äº€">ä¸¸äº€</option>
                            <option value="å…å³¶">å…å³¶</option>
                            <option value="å®®å³¶">å®®å³¶</option>
                            <option value="å¾³å±±">å¾³å±±</option>
                            <option value="ä¸‹é–¢">ä¸‹é–¢</option>
                            <option value="è‹¥æ¾">è‹¥æ¾</option>
                            <option value="èŠ¦å±‹">èŠ¦å±‹</option>
                            <option value="ç¦å²¡">ç¦å²¡</option>
                            <option value="å”æ´¥">å”æ´¥</option>
                            <option value="å¤§æ‘">å¤§æ‘</option>
                        </select>
                    </div>

                    <!-- æ—¥ä»˜é¸æŠ -->
                    <div class="form-group">
                        <label for="date">ğŸ“… æ—¥ä»˜</label>
                        <input type="date" id="date">
                    </div>

                    <!-- ãƒ¬ãƒ¼ã‚¹ç•ªå·é¸æŠ -->
                    <div class="form-group">
                        <label for="race_num">ğŸ ãƒ¬ãƒ¼ã‚¹ç•ªå·</label>
                        <select id="race_num">
                            <option value="1">1R</option>
                            <option value="2">2R</option>
                            <option value="3">3R</option>
                            <option value="4">4R</option>
                            <option value="5" selected>5R</option>
                            <option value="6">6R</option>
                            <option value="7">7R</option>
                            <option value="8">8R</option>
                            <option value="9">9R</option>
                            <option value="10">10R</option>
                            <option value="11">11R</option>
                            <option value="12">12R</option>
                        </select>
                    </div>
                </div>

                <!-- äºˆæƒ³ç”Ÿæˆãƒœã‚¿ãƒ³ -->
                <button class="btn-generate" id="generateBtn">ğŸš€ äºˆæƒ³ç”Ÿæˆã‚¹ã‚¿ãƒ¼ãƒˆ</button>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>äºˆæƒ³ã‚’ç”Ÿæˆä¸­ã§ã™...ï¼ˆæœ€å¤§5åˆ†ï¼‰</p>
                </div>
            </div>

            <!-- ===== ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºéƒ¨åˆ† ===== -->
            <div class="error" id="error">
                <strong>âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š</strong>
                <p id="errorMessage"></p>
            </div>

            <!-- ===== è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ† ===== -->
            <div class="warning" id="warning">
                <strong>âš ï¸ é–‹å‚¬æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“</strong>
                <p id="warningMessage"></p>
            </div>

            <!-- ===== æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éƒ¨åˆ† ===== -->
            <div class="success" id="success">
                <strong>âœ… æˆåŠŸï¼</strong>
                <p id="successMessage"></p>
            </div>

            <!-- ===== çµæœè¡¨ç¤ºéƒ¨åˆ† ===== -->
            <div class="result-section" id="resultSection">
                <div class="result-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0;">ğŸ“Š äºˆæƒ³çµæœ</h2>
                        <button class="btn-copy" id="copyBtn">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
                    </div>
                </div>
                <div class="result-content" id="resultContent"></div>
            </div>
        </div>
    </div>

    <!-- ===== JavaScriptéƒ¨åˆ† ===== -->
    <script>
        // ============================================
        // æ—¥ä»˜è¨­å®šï¼šæœ¬æ—¥ï½æ˜æ—¥ã¾ã§ã®ã¿é¸æŠå¯èƒ½
        // ============================================
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«å¤‰æ›
        const todayStr = today.toISOString().split('T')[0];
        const tomorrowStr = tomorrow.toISOString().split('T')[0];

        const dateInput = document.getElementById('date');
        dateInput.value = todayStr;      // â† æœ¬æ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        dateInput.max = tomorrowStr;     // â† æ˜æ—¥ã¾ã§ã—ã‹é¸æŠä¸å¯

        // ============================================
        // CSRF ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—é–¢æ•°
        // ============================================
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ============================================
        // ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        // ============================================
        document.getElementById('copyBtn').addEventListener('click', function() {
            const resultContent = document.getElementById('resultContent').textContent;
            
            if (!resultContent) {
                alert('ã‚³ãƒ”ãƒ¼ã™ã‚‹çµæœãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
            navigator.clipboard.writeText(resultContent).then(() => {
                // ã‚³ãƒ”ãƒ¼æˆåŠŸæ™‚ã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
                const toast = document.createElement('div');
                toast.className = 'copy-toast';
                toast.textContent = 'âœ… çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
                document.body.appendChild(toast);

                // 2ç§’å¾Œã«æ¶ˆå»
                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }).catch(err => {
                alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            });
        });

        // ============================================
        // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
        // ============================================
        document.getElementById('generateBtn').addEventListener('click', async function() {
            const btn = this;
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—
            const location = document.getElementById('location').value;
            const date = document.getElementById('date').value;
            const race_num = document.getElementById('race_num').value;

            console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', { location, date, race_num });

            // UI çŠ¶æ…‹ã‚’å¤‰æ›´
            btn.disabled = true;
            document.getElementById('loading').classList.add('active');
            document.getElementById('error').classList.remove('active');
            document.getElementById('warning').classList.remove('active');
            document.getElementById('success').classList.remove('active');
            document.getElementById('resultSection').classList.remove('active');

            try {
                // Django API ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
                console.log('CSRF Token:', csrfToken);
                console.log('All Cookies:', document.cookie);

                const requestBody = JSON.stringify({
                    location: location,
                    date: date,
                    race_num: parseInt(race_num)
                });
                console.log('Request Body:', requestBody);

                const response = await fetch('/api/generate/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken || ''
                    },
                    credentials: 'same-origin',
                    body: requestBody
                });

                console.log('Response Status:', response.status);
                console.log('Response Headers:', response.headers);

                const data = await response.json();
                console.log('Response Data:', data);

                if (response.ok && data.status === 'success') {
                    // æˆåŠŸæ™‚ï¼šçµæœã‚’è¡¨ç¤º
                    document.getElementById('successMessage').textContent = data.message;
                    document.getElementById('success').classList.add('active');
                    document.getElementById('resultContent').textContent = data.output;
                    document.getElementById('resultSection').classList.add('active');
                } else if (data.status === 'warning') {
                    // è­¦å‘Šæ™‚ï¼šé–‹å‚¬ãªã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    const warningMsg = `${data.date} ${data.location}ç«¶è‰‡å ´ã®é–‹å‚¬ã®ãƒ¬ãƒ¼ã‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                    <br>è©³ç´°ã¯ä»¥ä¸‹ã‚’ã”ç¢ºèªãã ã•ã„<br>
                    <a href="${data.url}" target="_blank">ğŸ“ ç«¶è‰‡å ´ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</a>`;
                    document.getElementById('warningMessage').innerHTML = warningMsg;
                    document.getElementById('warning').classList.add('active');
                } else {
                    // ã‚¨ãƒ©ãƒ¼æ™‚ï¼šã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    document.getElementById('errorMessage').textContent = data.message || 'Unknown error';
                    document.getElementById('error').classList.add('active');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                document.getElementById('errorMessage').textContent = 
                    `ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—: ${error.message}`;
                document.getElementById('error').classList.add('active');
            } finally {
                // ãƒœã‚¿ãƒ³ã¨èª­ã¿è¾¼ã¿ã‚’æˆ»ã™
                btn.disabled = false;
                document.getElementById('loading').classList.remove('active');
            }
        });
    </script>
</body>
</html>